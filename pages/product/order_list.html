<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <script src="https://unpkg.com/alpinejs@3.14.8/dist/cdn.min.js" defer></script>
</head>
<body>
    <div class="ui container" x-data="{
        orders: [],
        loading: true,
        error: null,
        message: null,
        selectedOrder: null,
        baseUrl: 'http://172.17.100.14:3326/santiago1',
        defaultImages: {
            products:  'http://172.17.100.14:3326/santiago1/spa/assets/default-product-image.png',
            avatars:  'http://172.17.100.14:3326/santiago1/spa/assets/default-avatar.png',
        },
        getImageUrl(item, type = 'products') {
            const imageField = type === 'products' ? 'image_url' : 'avatar';
            const defaultImage = this.defaultImages[type];

            if (!item || !item[imageField]) {
                console.debug(`No ${imageField} for:`, item?.name);
                return defaultImage;
            }

            try {
                const imagePath = item[imageField];
                if (!imagePath) return defaultImage;

                // Handle full URLs - from display logic
                if (imagePath.startsWith('http')) {
                    // Use the same logic as product display
                    try {
                        const url = new URL(imagePath);
                        const filename = url.pathname.split('/').pop();
                        return `${this.baseUrl}/media/products/${filename}`;
                    } catch (e) {
                        console.error('Invalid image URL:', imagePath);
                        return defaultImage;
                    }
                }

                // Handle relative paths for avatars
                if (type === 'avatars') {
                    const filename = imagePath.split('/').pop();
                    const mediaUrl = `${this.baseUrl}/media/avatars/${filename}`;
                    
                    // Add debug logging
                    console.debug(`Loading ${type} image:`, {
                        original: imagePath,
                        processed: mediaUrl,
                        item: item.name || 'unknown'
                    });
                    console.log('Constructed image URL:', mediaUrl);
                    console.log('Avatar URL:', mediaUrl);
                    
                    return mediaUrl;
                }
                
                return defaultImage;
            } catch (error) {
                console.error(`Error processing ${type} image:`, error);
                return defaultImage;
            }
        },
        getImageUrl(product) {
            if (!product?.image_url) {
                console.warn('No image URL for:', product?.name);
                return '/spa/assets/default-product-image.png';
            }
            try {
                const url = new URL(product.image_url);
                return `${this.baseUrl}/media/products/${url.pathname.split('/').pop()}`;
            } catch (e) {
                console.error('Invalid image URL:', product.image_url);
                return '/spa/assets/default-product-image.png';
            }
        },
        formatDate(date) {
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        formatPrice(price) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(price);
        },
        async fetchOrders() {
            try {
                this.loading = true;
                const response = await fetch(`${this.baseUrl}/api/payments/`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Debug logging
                data.forEach(order => {
                    console.debug('Order:', {
                        id: order.id,
                        name: order.name,
                        avatar: order.avatar,
                        products: order.products.map(p => ({
                            id: p.id,
                            name: p.name,
                            image_url: p.image_url
                        }))
                    });
                });
                
                this.orders = data;
            } catch (error) {
                this.error = `Error fetching orders: ${error.message}`;
                console.error('Fetch orders error:', error);
            } finally {
                this.loading = false;
            }
        }
    }" x-init="fetchOrders">

        <!-- Navigation -->
        <div class="navbar">
            <div class="ui container">
                <div class="ui secondary pointing menu">
                    <div class="item">
                        <h2 class="ui header">
                            <i class="shopping bag icon"></i>
                            <div class="content">Product Store</div>
                        </h2>
                    </div>
                    <div class="right menu">
                        <a href="index.html#product/product_display" class="item">
                            <i class="shopping bag icon"></i> Products
                        </a>
                        <a href="index.html#product/view_cart" class="item">
                            <i class="shopping cart icon"></i> Cart
                        </a>
                        <div class="active item">
                            <i class="history icon"></i> Order History
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages">
            <div class="ui negative message" x-show.transition="error" x-cloak>
                <i class="close icon" @click="error = null"></i>
                <div class="content" x-text="error"></div>
            </div>
            <div class="ui positive message" x-show.transition="message" x-cloak>
                <i class="close icon" @click="message = null"></i>
                <div class="content" x-text="message"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="order-segment">
            <!-- Loading State -->
            <div class="ui active dimmer" x-show.transition="loading" x-cloak>
                <div class="ui text loader">Loading orders...</div>
            </div>

            <!-- Orders List -->
            <div x-show="!loading && orders.length > 0" class="order-list">
                <template x-for="order in orders" :key="order.id">
                    <div class="order-card">
                        <!-- Order Header -->
                        <div class="content">
                            <div class="ui grid">
                                <div class="eight wide column">
                                    <h3 class="ui header">
                                        <i class="shopping bag icon"></i>
                                        <div class="content">
                                            Order #<span x-text="order.id"></span>
                                            <div class="sub header" x-text="formatDate(order.created_at)"></div>
                                        </div>
                                    </h3>
                                </div>
                                <div class="eight wide right aligned column">
                                    <div class="ui label" 
                                         :class="{
                                             'blue': order.payment_method === 'paypal',
                                             'green': order.payment_method === 'gcash',
                                             'purple': order.payment_method === 'maya'
                                         }">
                                        <i class="payment icon"></i>
                                        <span x-text="order.payment_method"></span>
                                    </div>
                                    <div class="ui label">
                                        <i class="money bill alternate icon"></i>
                                        <span x-text="formatPrice(order.total_amount)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Details -->
                        <div class="content customer-details">
                            <h4 class="ui sub header">Customer Information</h4>
                            <div class="ui grid">
                                <div class="four wide column">
                                    <!-- For avatar images -->
                                    <img :src="getImageUrl(order, 'avatars')"
                                         :alt="'Avatar of ' + order.name"
                                         class="ui small circular image"
                                         loading="lazy"
                                         @error="(e) => { 
                                             console.debug('Avatar load failed:', order.name);
                                             e.target.src = defaultImages.avatars;
                                         }">
                                </div>
                                <div class="twelve wide column">
                                    <div class="ui list">
                                        <div class="item">
                                            <i class="user icon"></i>
                                            <div class="content" x-text="order.name"></div>
                                        </div>
                                        <div class="item">
                                            <i class="mail icon"></i>
                                            <div class="content" x-text="order.email"></div>
                                        </div>
                                        <div class="item">
                                            <i class="map marker alternate icon"></i>
                                            <div class="content" x-text="order.address"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products List in order-card -->
                        <div class="content">
                            <h4 class="ui sub header">
                                Ordered Items
                                <button class="ui basic right floated button" 
                                        @click="selectedOrder = selectedOrder === order ? null : order">
                                    <i class="icon" :class="selectedOrder === order ? 'chevron up' : 'chevron down'"></i>
                                    <span x-text="selectedOrder === order ? 'Hide Details' : 'Show Details'"></span>
                                </button>
                            </h4>
                            <div class="ui relaxed divided items" x-show="selectedOrder === order" x-transition>
                                <template x-for="product in order.products" :key="product.id">
                                    <div class="item">
                                        <div class="ui tiny image">
                                            <!-- For product images -->
                                            <img :src="getImageUrl(product, 'products')" 
                                                 :alt="product.name"
                                                 class="ui tiny image"
                                                 loading="lazy"
                                                 @error="(e) => {
                                                     console.debug('Product image load failed:', product.name);
                                                     e.target.src = defaultImages.products;
                                                 }">
                                        </div>
                                        <div class="content">
                                            <div class="header" x-text="product.name"></div>
                                            <div class="meta">
                                                <span x-text="formatPrice(product.price)"></span>
                                            </div>
                                            <div class="description">
                                                <p x-text="'Quantity: ' + product.quantity"></p>
                                                <p x-text="'Subtotal: ' + formatPrice(product.price * product.quantity)"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div class="empty-state" x-show="!loading && orders.length === 0">
                <div class="ui icon header">
                    <i class="history icon large"></i>
                    No Orders Found
                </div>
                <p>Start shopping to view your order history!</p>
                <a href="index.html#product/product_display" class="ui primary button">
                    <i class="shopping cart icon"></i>
                    Start Shopping
                </a>
            </div>
        </div>
    </div>
        <style>
            :root {
            --primary-color: #a80016;
            --secondary-color: #28a745;
            --danger-color: #e53935;
            --text-color: #fafcff;
            --muted-color: #c3ddf3;
            --light-gray: #0a0a0a;
            --card-bg: #3a3a3a;
            --border-color:#1d1d1d;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        body {
            background-color: var(--light-gray);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        [x-cloak] {
            display: none !important;
        }

        .navbar {
            background-color: var(--card-bg);
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .ui.secondary.pointing.menu {
            border-bottom: none;
            margin: 0;
        }

        .ui.secondary.pointing.menu .item {
            padding: 0.75rem 1.25rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .ui.secondary.pointing.menu .item:hover,
        .ui.secondary.pointing.menu .active.item {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .order-segment {
            padding: 2rem 0;
        }

        .messages {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
            width: 320px;
        }

        .ui.message {
            border-left: 4px solid;
            border-radius: 5px;
            box-shadow: var(--shadow);
        }

        .ui.negative.message {
            background: #ffe5e5;
            border-left-color: var(--danger-color);
        }

        .ui.positive.message {
            background: #e6ffed;
            border-left-color: var(--secondary-color);
        }

        .ui.message .close.icon {
            opacity: 0.5;
        }
        .ui.message .close.icon:hover {
            opacity: 1;
        }

        .ui.active.dimmer {
            background: rgba(255, 255, 255, 0.8);
        }
        .ui.text.loader {
            color: var(--text-color);
        }

        .order-card {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .ui.header {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .sub.header {
            font-size: 0.9rem;
            color: var(--muted-color);
        }

        .ui.label {
            border-radius: 1rem;
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            margin: 0 0.3rem;
            background-color: #f1f3f5;
            color: var(--text-color);
            font-weight: 500;
        }

        .ui.label.blue {
            background-color: #e3f2fd;
            color: #0d6efd;
        }
        .ui.label.green {
            background-color: #e6ffed;
            color: #28a745;
        }
        .ui.label.purple {
            background-color: #f3e5f5;
            color: #6f42c1;
        }

        .customer-details .ui.small.circular.image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: var(--shadow);
            background: #e9ecef;
        }

        .ui.list .item {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .ui.relaxed.divided.items .item {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
        }
        .ui.relaxed.divided.items .item:last-child {
            border-bottom: none;
        }

        .ui.tiny.image {
            width: 80px;
            height: 80px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .ui.tiny.image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ui.basic.button {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .ui.basic.button:hover {
            background: var(--primary-color);
            color: #fff;
        }

        .empty-state {
            text-align: center;
            margin: 2rem 0;
        }
        .empty-state .ui.icon.header {
            font-size: 1.5rem;
            color: var(--muted-color);
        }
        .empty-state p {
            color: var(--muted-color);
            margin-bottom: 1rem;
        }
        .empty-state .ui.button {
            background: var(--primary-color);
            color: white;
            border-radius: 5px;
            padding: 0.75rem 1.5rem;
        }
        .empty-state .ui.button:hover {
            background: #004bb5;
        }

        @media only screen and (max-width: 768px) {
            .order-card {
                padding: 1rem;
            }

            .ui.grid > .column {
                padding: 0.5rem !important;
            }

            .messages {
                width: 90%;
                right: 5%;
            }

            .ui.small.circular.image {
                width: 48px !important;
                height: 48px !important;
            }

            .ui.tiny.image {
                width: 64px;
                height: 64px;
            }
            }
            .ui.basic.button {
                background-color: var(--primary-color);
                color: #fff;
                border: none;
                transition: background 0.3s ease;
            }

            .ui.basic.button:hover {
                background-color: #1678c2;
            }
        </style>
</body>
</html>